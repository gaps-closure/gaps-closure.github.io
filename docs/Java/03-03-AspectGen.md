## Auto Generation of Aspects for Partition Enforcement and Cross Domain Communications {#AspectJ} 

Given the annotated application and the topology, the Java code generation tool, CodeGenJava, does the following:

- creates a directory for each partition and copies the original app code into it; [directory](#codeGenOutput)
- generates AspectJ definitions for each partition; [aspect-example](#video.aspectj)
- generates cross-domain tags and HAL configurations; [xdconf](#xdconf) and [hal-purple.cfg](#hal-purple)
- generates remote procedure call handlers; [handler](#slave-handler)
- generates an ant build script for each enclave [build.xml](#ant) and
- compiles and aspect weaves the resulting code.

Aspect-oriented programming (AOP) is a programming paradigm that aims to
increase modularity by allowing the separation of cross-cutting concerns. It
does so by adding behavior to existing code ("advice") without modifying the
code itself, instead separately specifying which code is modified (a "pointcut"
specification). For example, an aspect can add behavior to log all function 
calls when the function name begins with `set`.

Aspect-oriented programming, illustrated in the [diagram](#aopArch) below, has
the benefits of clean modularization of cross-cutting concerns. The annotated
source code need not be modified, as the aspects are woven in by the compiler
when generating the executable. 

![Aspect-Oriented Programming Concept](docs/Java/images/aopArch.png){#aopArch}

CLOSURE's approach to AOP is the following. A developer annotates Java
application code using CLE and performs cross-domain analysis at the Java/Dalvik
bytecode level.  AspectJ code is auto-generated by CLOSURE, so the programmer need
not learn AOP concepts. The CVI build process takes care of invocation of the AspectJ 
compiler.

Based on the 'cuts' in the topology JSON file, CodeGenJava generates the
necessary Aspect definitions to intercept cross-domain calls and forward them
to the remote enclave via the the HAL layer. The following diagram depicts 
the process of object instantiation and method invocation.

![Constructor and Method Invocation](docs/Java/images/methodInvoke.png){#invoke}

For cross-domain object instantiation, the generated AspectJ pointcut
corresponding to the constructor intercepts the invocation, generates a shadow
object and assigns an object id (oid).  The constructor invocation and oid are
then serialized to the remote enclave through RPC over HAL. The remote handler
deserializes the constructor call, unmarshalls the arguments, instantiates the 
object by calling the constructor, and stores a local instance along with a map 
between the oid and the instance.

Cross-domain method invocations are handled similarly. For invoking an instance
method, the Aspect defined on the caller side looks up the oid corresponding to 
the object, serializes the method request along with and oid and sends to the 
remote enclave through RPC over HAL.

The remote handler deserializes the call, looks up the object corresponding to 
the oid and invokes the specified method. The return value is serialized and 
passed back along the reverse path. Upon receiving the return value, the
generated aspect code deserializes the response, unmarshalls the arguments,
and provides it to the caller method.

To build CodeGenJava from source, do the following:

```bash
$ cd CodeGenJava
$ ant
```

If successful, this will create a directory named code-gen containing a jar
file, `code-gen.jar`, and a subdirectory named `resources`. For
convenience in deployment, a zip file, `code-gen.zip`, which contains the 
same contents as the `code-gen` directory is also generated. 

The usage of the program CodeGenJava is straightforward:

```bash
$ java -jar code-gen/code-gen.jar -h
GAPS/Closure Java Code Generator
  -h/--help                    this help
  -c/--cutJson <cut.json>      cut JSON file (test/cut.json)
  -d/--dstDir  <pathname>      destination directory of the generated code (/home/closure/gaps/xdcc)
  -f/--config  <config.json>   config JSON file
  -i/--codeDir <source code>   code directory relative to srcDir (.)
  -j/--jar     <jar name>      name of the application jar file (TESTPROGRAM)
  -p/--compile <true|false>    Compile the code after partition (true)
  -s/--srcDir  <app src dir>   application source code (/home/closure/gaps/capo/Java/examples/eop2-demo)
```

Without arguments, CodeGenJava uses the default arguments shown in the
parentheses at the end of the options above. A JSON config file can also be
provided. An excerpt of the config is given below. A full sample config.json is
given in the [appendix](#config.json).

```json
{
  "dstDir": "/home/closure/xdcc",
  "cut": "test/cut.json",
  "srcDir": "/home/closure/gaps/capo/Java/examples/eop2-demo",
  "codeDir": ".",
  "jar": "TESTPROGRAM",
  "compile": true,
}
```

